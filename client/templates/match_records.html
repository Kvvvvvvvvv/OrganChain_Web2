<!DOCTYPE html>
<html>
<head>
    <title>Match Records</title>
    <link rel="stylesheet" href="../static/style.css">
    <style>
        .unique-id-cell {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            background: var(--bg-tertiary);
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--text-muted);
        }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="nav-container">
        <a class="brand" href="/login">Organ Donor Chain</a>
        <ul class="nav-links">
            <li><a href="/logout">Logout</a></li>
        </ul>
    </div>
</nav>
<section class="hero">
    <div class="hero-inner">
        <h1>Match Records</h1>
        <p>All successful donor-patient matches are listed below.</p>
    </div>
</section>
<div class="container">
    <h2>Match History (First-Come-First-Serve)</h2>
    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>Donor Name</th>
                    <th>Donor ID</th>
                    <th>Patient Name</th>
                    <th>Patient ID</th>
                    <th>Organ</th>
                    <th>Blood Type</th>
                    <th>Donor Hospital</th>
                    <th>Patient Hospital</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody>
                {% for match in matches %}
                <tr>
                    <td>{{ match.donor_name }}</td>
                    <td class="unique-id-cell">{{ match.donor_unique_id[:8] }}...</td>
                    <td>{{ match.patient_name }}</td>
                    <td class="unique-id-cell">{{ match.patient_unique_id[:8] }}...</td>
                    <td><span class="organ-badge">{{ match.organ }}</span></td>
                    <td><span class="blood-type-badge">{{ match.blood_type }}</span></td>
                    <td><span class="hospital-badge">{{ match.donor_hospital }}</span></td>
                    <td><span class="hospital-badge">{{ match.patient_hospital }}</span></td>
                    <td class="registration-date">{{ match.match_date[:10] if match.match_date else 'N/A' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Blockchain Matches Section -->
    <div id="blockchain-matches-section" style="margin-top: 40px; display: none;">
        <h2>Blockchain Match Records</h2>
        <div class="table-container">
            <table id="blockchain-matches-table">
                <thead>
                    <tr>
                        <th>Donor Name</th>
                        <th>Donor Organ</th>
                        <th>Donor Blood Type</th>
                        <th>Donor Hospital</th>
                        <th>Patient Name</th>
                        <th>Patient Organ</th>
                        <th>Patient Blood Type</th>
                        <th>Patient Hospital</th>
                        <th>Date</th>
                    </tr>
                </thead>
                <tbody id="blockchain-matches-body">
                    <!-- Blockchain matches will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
    
    <br>
    <a href="/matches" class="btn-primary">Run New Match</a>
</div>

<script>
// Function to load matches from blockchain
async function loadBlockchainMatches() {
    try {
        const res = await fetch('/api/matches');
        const json = await res.json();
        if (json.ok) {
            const matches = json.matches;
            const tbody = document.getElementById('blockchain-matches-body');
            
            // Clear existing content
            tbody.innerHTML = '';
            
            // Show the blockchain section
            document.getElementById('blockchain-matches-section').style.display = 'block';
            
            // Add matches to table
            matches.forEach(match => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${match.donorName}</td>
                    <td>${match.donorOrgan}</td>
                    <td>${match.donorBloodType}</td>
                    <td>${match.donorHospital}</td>
                    <td>${match.patientName}</td>
                    <td>${match.patientOrgan}</td>
                    <td>${match.patientBloodType}</td>
                    <td>${match.patientHospital}</td>
                    <td>${match.date}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (matches.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9" style="text-align: center;">No matches found on blockchain</td></tr>';
            }
        } else {
            console.error('Error loading blockchain matches:', json.error);
        }
    } catch (error) {
        console.error('Error fetching blockchain matches:', error);
    }
}

// Load blockchain matches when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadBlockchainMatches();
});

// Function to add a match to blockchain (for testing)
async function addMatchToBlockchain(matchObj) {
    try {
        const res = await fetch('/api/matches', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(matchObj)
        });
        return await res.json();
    } catch (error) {
        console.error('Error adding match to blockchain:', error);
        return {ok: false, error: error.message};
    }
}
</script>
</body>
</html>